# UART TX RX Demo

You will learn UART and its interrupt programming by this demo. In order not to add new peripherals, use UART TX RX to control the times of LED on/off. As shown in Figure 1, short-circuit UART TX RX pins, and control the times of LED1 on/off according to the RX data.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/UART board pic (1).png" width= "400">

This demo includes four parts:

1. UART Introduction
2. Hardware Design
3. Software Design
4. Download and Verification

## UART Introduction

Gowin GW1NSR-LV4CQN48P is used as the platform in this demo. From DS861, GW1NSR series of FPGA Products Datasheet, you can learn the UART module.

The SoC embedded with microprocessor system contains two UARTs: UART0 and UART1. These can be accessed and controlled through APB1 bus. The max. baud rate supported is 921.6Kbits/s. UART0 and UART1 support 8 bits communication without parity and one stop bit. APB UART Buffering diagram is as shown in Figure 2.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/UART diagram (2).png" width= "400">

As shown in Figure 2, UART transmits and receives data to/from CPU through the buffers, and the baud rate is related to the APB. Figure 3 lists UART registers.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/UART figure 3 (3).png" width= "400">

To program UART, the first step is to configure UART registers, and also to configure the nested vector interrupt controller (NVIC). For the NVIC details, you can see 3.11.4 section of DS861, GW1NSR series of FPGA Products Datasheet.

The register configuration is defined in gw1ns4c_uart.h in the library file directory, and the definition is as shown below:

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/typedef (4).png" width= "400">

## Hardware Design

This demo can be modified on the basis of the LED project. LED is on in LOW and off in HIGH. In this demo, short-circuit UART TX RX pins and use an LED as the display to test. Therefore, only LED1 needs to be connected to the corresponding FPGA port.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 4 (5).png" width= "400">

## Software Design

The software design includes two parts: FPGA internal hardware logic and Cotex-M3 software control code, which can be modified on the basis of the LED project.

## FPGA Internal Logic Design

You need to modify the HDL to add UART module to the IP.

### Step 1: Add UART module to the IP

Click "IP Core Generator" to open the gowin_empu.ipc file in the FPGA project folder as shown in Figure 5.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 5 (6).png" width= "400">

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 6 (7).png" width= "400">

Double-click on the UART and select UART0 as shown in Figure 6. Click "OK" to generate a new core configuration file, and add it to the project file.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 7 (8).png" width= "400">

### Step 2: Modify top file

Add UART TX RX pins to the top, and connect UART signals generated by the core to the interface signals defined by the top, as shown in Figure 8. Click "Synthesize" to synthesize the file.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 8 (9).png" width= "400">

### Step 3: Define UART pin

Double-click on "FloorPlanner" to define the pins. The pin definition is shown in Figure 9.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 9 (10).png" width= "400">

Then click Place & Route to generate the logic file fpga_led.fs.

## Cotex-M3 Software Control Design

You can modify this design on the basis of the LED project. 

Open Led.uvprojx in the Keil_led\PROJECT folder.

1. Group interrupt

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/code line 1 (11).png" width= "400">

2. Set GPIO0[0] to output to drive LED.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/Code line 2 (12).png" width= "400">

3. Set UART registers

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/code line 3 (13).png" width= "400">

4. Set UART0 interrupts

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/code line 4 (14).png" width= "400">

5. Program interrupt, and the library function is in the gw1ns4c_it.c.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/program interrupt (15).png" width= "400">

6. In the main design, add init function and set UART_sendchar to 4.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/main void (16).png" width= "400">

7. After bulid, the download file led.bin is generated.

## Download and Verification

Use Gowin Software to download, and the demo running is as shown in Figure 10. The FPGA hardware platform file is fpga_led.fs, and the Cotex-M3 software file is led.bin, so be careful to choose the correct file path and bulid file.

<img src="/projects/UART0 Interrupt Demo/uart0_int_run/images/figure 10 (17).png" width= "400">
